name: Build DEV Docker image
run-name: Build the asWiki app's DEV Docker image
on:
    workflow_run:
        workflows: ["Build & Test"]
        types:
            - completed
        branches:
            - develop

jobs:
    DEV-Build-Docker:
        runs-on: ubuntu-latest
        container:
            image: 'docker:dind'
        permissions:
            contents: read
            packages: write
        env:
            BUILD_NUMBER: ${{ github.run_number }}
            REGISTRY: ghcr.io
            IMAGE_NAME: ${{ github.repository }}
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
            - name: UI Docker Build
              run: |
                    cd ui
                    docker buildx build --platform linux/amd64,linux/arm64 -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-ui:latest-dev -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-ui:0.0.$BUILD_NUMBER-dev .
                    docker login ${{ env.REGISTRY }} -u ${{ github.actor }} -p ${{ secrets.REPOSITORY_TOKEN }}
                    docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-ui:latest-dev
                    docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-ui:0.0.$BUILD_NUMBER-dev
            - name: SRV Docker Build
              run: |
                    cd server
                    docker buildx build --platform linux/amd64,linux/arm64 -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-srv:latest-dev -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-srv:0.0.$BUILD_NUMBER-dev .
                    docker login ${{ env.REGISTRY }} -u ${{ github.actor }} -p ${{ secrets.REPOSITORY_TOKEN }}
                    docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-srv:latest-dev
                    docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-srv:0.0.$BUILD_NUMBER-dev
